<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>川渝城市群家乡连线地图 - 智能虚实版</title>
    <style>
        /* ------------------ 样式部分 ------------------ */
        body { margin: 0; padding: 0; overflow: hidden; background: #0b1120; }
        #chart-container { width: 100vw; height: 100vh; }

        /* 右上角二维码悬浮窗 */
        #qrcode-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 27, 59, 0.9);
            border: 1px solid #00f2ff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            z-index: 999;
            text-align: center;
        }
        #qrcode-container p {
            color: #00f2ff;
            margin: 0 0 10px 0;
            font-size: 14px;
            font-family: "Microsoft YaHei", sans-serif;
            font-weight: bold;
        }
        #qrcode img {
            padding: 5px;
            background: white;
            border-radius: 4px;
        }

        /* 左上角操作控制面板 */
        #controls-container {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(16, 27, 59, 0.95);
            border: 1px solid #00f2ff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
            z-index: 999;
            width: 260px;
        }
        #controls-container h3 {
            color: #fff;
            margin: 0 0 15px 0;
            font-size: 16px;
            font-family: "Microsoft YaHei", sans-serif;
            border-bottom: 1px solid #1E88E5;
            padding-bottom: 10px;
        }
        .control-group { margin-bottom: 15px; }
        select {
            width: 100%;
            padding: 10px;
            background: #0b1120;
            color: #00f2ff;
            border: 1px solid #1785BF;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        .btn-row { display: flex; gap: 10px; }
        button {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            color: white;
            transition: all 0.3s;
            font-weight: bold;
        }
        .btn-add {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            box-shadow: 0 0 10px rgba(0, 198, 255, 0.4);
        }
        .btn-clear {
            background: linear-gradient(90deg, #ff0844, #ffb199);
            box-shadow: 0 0 10px rgba(255, 8, 68, 0.4);
        }
        .btn-add:hover, .btn-clear:hover { transform: scale(1.05); }

        /* 加载提示 */
        #loading {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #00f2ff;
            font-size: 20px;
            font-family: sans-serif;
            z-index: 1000;
            text-shadow: 0 0 10px #00f2ff;
        }
    </style>

    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>

    <div id="loading">正在加载川渝地图数据...</div>

    <div id="chart-container"></div>

    <div id="controls-container">
        <h3>控制台</h3>
        <div class="control-group">
            <select id="pcCitySelect">
                <option value="">-- 选择起点城市 --</option>
            </select>
        </div>
        <div class="control-group">
            <select id="pcDestinationSelect">
                <option value="">-- 选择终点城市 --</option>
            </select>
        </div>
        <div class="control-group">
            <select id="pcWeightSelect">
                <option value="5">-- 选择权重 (默认为5) --</option>
                <option value="1">1 (细 - 青色)</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4 (中 - 紫色)</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8 (粗 - 金色)</option><option value="9">9</option>
                <option value="10">10 (极粗 - 红色)</option>
            </select>
        </div>
        <div class="btn-row">
            <button class="btn-add" onclick="manualAddLine()">生成连线</button>
            <button class="btn-clear" onclick="clearAllLines()">清除连线</button>
        </div>
    </div>

    <div id="qrcode-container">
        <p>手机扫码互动</p>
        <div id="qrcode"></div>
    </div>

    <script>
        // ---------------------- 1. 基础配置 (城市列表) ----------------------
        const cityCoords = {
            // -------------------- 重庆市 (38个区县) --------------------
            "重庆市": [106.550464, 29.563009], "渝中区": [106.587254, 29.554681], "大渡口区": [106.498954, 29.532517],
            "江北区": [106.568652, 29.582741], "沙坪坝区": [106.442734, 29.579036], "九龙坡区": [106.468845, 29.513925],
            "南岸区": [106.597446, 29.504003], "北碚区": [106.334113, 29.813385], "渝北区": [106.648904, 29.626314],
            "巴南区": [106.517436, 29.417875], "万州区": [108.353036, 30.835791], "涪陵区": [107.388987, 29.705898],
            "黔江区": [108.875878, 29.516586], "长寿区": [106.977171, 29.866618], "江津区": [106.25, 29.28],
            "合川区": [106.26, 30.04], "永川区": [105.90, 29.35], "南川区": [107.09, 29.17], "綦江区": [106.67, 29.17],
            "大足区": [105.71, 29.82], "璧山区": [106.27, 29.59], "铜梁区": [106.06, 30.08], "潼南区": [105.85, 30.22],
            "荣昌区": [105.59, 29.40], "开州区": [108.3800, 31.1890], "梁平区": [107.82, 30.63], "武隆区": [107.76, 29.35],
            "城口县": [108.72, 31.95], "丰都县": [107.73, 29.87], "垫江县": [107.34, 30.31], "忠县": [108.03, 30.28],
            "云阳县": [108.70, 30.91], "奉节县": [109.47, 31.02], "巫山县": [109.87, 31.07], "巫溪县": [109.64, 31.43],
            "石柱土家族自治县": [108.06, 30.04], "秀山土家族苗族自治县": [108.99, 28.47], "酉阳土家族苗族自治县": [108.76, 28.84],
            "彭水苗族土家族自治县": [108.16, 29.28],
            // -------------------- 四川省 (21个市州) --------------------
            "成都市": [104.065735, 30.659462], "绵阳市": [104.755164, 31.474372], "德阳市": [104.386120, 31.131889],
            "宜宾市": [104.635578, 28.760958], "泸州市": [105.386194, 28.881175], "乐山市": [103.760285, 29.594672],
            "南充市": [106.082530, 30.836056], "达州市": [107.501748, 31.202922], "自贡市": [104.773416, 29.344625],
            "攀枝花市": [101.717737, 26.582510], "广元市": [105.836910, 32.447577], "遂宁市": [105.589199, 30.504735],
            "内江市": [105.059389, 29.594176], "眉山市": [103.863916, 30.049309], "广安市": [106.633259, 30.482867],
            "雅安市": [103.005206, 30.082139], "资阳市": [104.668610, 30.124518], "巴中市": [106.759111, 31.860926],
            "凉山彝族自治州": [102.269390, 27.921766], "阿坝藏族羌族自治州": [103.0905, 31.9009], "甘孜藏族自治州": [101.9566, 30.0410]
        };

        // 连线数据缓存
        let lineData = [];

        // 静态点位
        const allCityPoints = Object.keys(cityCoords).map(name => ({
            name: name,
            value: [...cityCoords[name]]
        }));

        // 填充下拉框
        const cityNames = Object.keys(cityCoords);
        cityNames.sort((a, b) => a.localeCompare(b, 'zh-CN'));
        cityNames.forEach(city => {
            const opt1 = document.createElement("option"); opt1.value = city; opt1.text = city;
            document.getElementById("pcCitySelect").appendChild(opt1);
            const opt2 = document.createElement("option"); opt2.value = city; opt2.text = city;
            document.getElementById("pcDestinationSelect").appendChild(opt2);
        });

        // ---------------------- 2. Firebase 初始化 ----------------------
        const firebaseConfig = {
            apiKey: "AIzaSyC8ShQbPovscKxEH-uN7HkCBbKAN514u5Q",
            authDomain: "maptest-7cc7d.firebaseapp.com",
            databaseURL: "https://maptest-7cc7d-default-rtdb.firebaseio.com",
            projectId: "maptest-7cc7d",
            storageBucket: "maptest-7cc7d.firebasestorage.app",
            messagingSenderId: "420772513972",
            appId: "1:420772513972:web:76fb5ce8e19b82be66afe1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ---------------------- 3. 样式工具函数 (颜色升级) ----------------------
        
        // 根据权重返回颜色：青蓝(1-3) -> 紫粉(4-7) -> 金红(8-10)
        function getColorByWeight(weight) {
            // 确保权重在 1-10 之间
            const w = Math.min(Math.max(weight, 1), 10);
            
            // 定义颜色阶梯 (Cyberpunk Palette)
            if (w <= 3) return '#00F2FF'; // 青色 Neon Cyan
            if (w <= 5) return '#0072FF'; // 亮蓝 Electric Blue
            if (w <= 7) return '#BC13FE'; // 霓虹紫 Neon Purple
            if (w <= 8) return '#FFD700'; // 金色 Gold
            return '#FF0055';             // 红色 Neon Red
        }

        function getLineStyle(weight, isSolid) {
            const color = getColorByWeight(weight);
            const maxShadow = 20;
            
            // 权重越大，线条越粗，光晕越强
            const lineWidth = 1.0 + (weight * 0.25); 
            const shadowBlur = Math.min(maxShadow, weight * 2);

            return {
                color: color,
                lineWidth: lineWidth,
                shadowBlur: shadowBlur
            };
        }

        // ---------------------- 4. ECharts 初始化 ----------------------
        const chart = echarts.init(document.getElementById('chart-container'));
        const textureImg = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAL0lEQVQIW2NkQAJ/Gf5vBAmwMYAAmAATEBPG///+/zcD8xn+//8PUgRTAzYAzCwA+2sXc9/j52QAAAAASUVORK5CYII=';
        const getTextureImage = () => { const img = new Image(); img.src = textureImg; return img; };

        Promise.all([
            fetch('./sichuan.json').then(r => r.json()),
            fetch('./chongqing.json').then(r => r.json())
        ]).then(([sichuanJson, chongqingJson]) => {
            const combinedFeatures = [...sichuanJson.features, ...chongqingJson.features];
            const combinedJson = { type: "FeatureCollection", features: combinedFeatures };
            echarts.registerMap('chuanyu', combinedJson);
            document.getElementById('loading').style.display = 'none';

            const option = {
                backgroundColor: '#0b1120',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(11, 17, 32, 0.9)',
                    borderColor: '#00F2FF',
                    textStyle: { color: '#fff' },
                    formatter: function (params) {
                        if (params.seriesType === 'lines') {
                            const data = params.data;
                            return `
                                <div style="border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 5px; padding-bottom: 5px;">
                                    <strong>${data.fromName}</strong> ${data.isSolid ? '→' : '⇢'} <strong>${data.toName}</strong>
                                </div>
                                情感权重: <span style="color:${params.color}; font-weight:bold">${data.weight}</span><br>
                                类型: ${data.isSolid ? '实线 (直达)' : '虚线 (返程/冲突)'}
                            `;
                        }
                        if (params.seriesType === 'effectScatter') {
                            return `城市: <strong>${params.name}</strong>`;
                        }
                        return '';
                    }
                },
                geo: {
                    map: 'chuanyu',
                    roam: true,
                    label: { show: false },
                    itemStyle: {
                        areaColor: '#101B3B', // 深蓝底色
                        borderColor: '#005f99', // 边框色
                        borderWidth: 1,
                        shadowColor: 'rgba(0, 242, 255, 0.3)', // 地图整体发光
                        shadowBlur: 10
                    },
                    emphasis: {
                        areaColor: '#174ea6',
                        label: { show: false }
                    }
                },
                series: [
                    { type: 'map', map: 'chuanyu', geoIndex: 0, label: { show: false }, select: { disabled: true } },
                    // 1. 静态背景点
                    { type: 'scatter', coordinateSystem: 'geo', zlevel: 5, data: allCityPoints, itemStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                    // 2. 实线 (Priority / Single)
                    {
                        type: 'lines',
                        zlevel: 3,
                        effect: {
                            show: true,
                            period: 4,
                            trailLength: 0.3, // 拖尾更长一点，更有动感
                            symbol: 'arrow',
                            symbolSize: 8,    // 箭头调大，更明显
                            color: '#fff'     // 飞线头始终亮白
                        },
                        lineStyle: {
                            normal: { curveness: 0.2 }
                        },
                        data: []
                    },
                    // 3. 虚线 (Conflict / Secondary)
                    {
                        type: 'lines',
                        zlevel: 3,
                        effect: {
                            show: true,
                            period: 4,
                            trailLength: 0.3,
                            symbol: 'circle', // 虚线用圆点
                            symbolSize: 4,
                            color: '#fff'
                        },
                        lineStyle: {
                            normal: { curveness: 0.2 }
                        },
                        data: []
                    },
                    // 4. 粒子特效 (光点)
                    {
                        type: 'lines',
                        zlevel: 4,
                        effect: {
                            show: true,
                            period: 4,
                            trailLength: 0.1,
                            symbol: 'circle',
                            symbolSize: 3
                        },
                        lineStyle: {
                            normal: { width: 0, curveness: 0.2 }
                        },
                        data: []
                    },
                    // 5. 起终点高亮涟漪
                    {
                        type: 'effectScatter',
                        coordinateSystem: 'geo',
                        zlevel: 6,
                        rippleEffect: { brushType: 'stroke', scale: 4 },
                        label: { show: true, formatter: '{b}', position: 'right', color: '#00F2FF', fontSize: 13, fontWeight: 'bold', textBorderColor: '#0b1120', textBorderWidth: 3 },
                        itemStyle: { color: '#00F2FF', shadowBlur: 10, shadowColor: '#fff' },
                        data: []
                    }
                ]
            };

            chart.setOption(option);
            startListening();

        }).catch(err => {
            console.error(err);
            document.getElementById('loading').innerText = "地图加载失败，请检查 ./data/ 目录下的 json 文件";
        });

        // ---------------------- 5. 核心逻辑控制 (智能冲突检测) ----------------------

        function updateChart() {
            // 1. 提取所有活跃点
            const activePointsSet = new Set();
            lineData.forEach(item => {
                activePointsSet.add(item.origin);
                activePointsSet.add(item.destination);
            });

            const activePoints = Array.from(activePointsSet).map(name => ({
                name: name,
                value: cityCoords[name] ? [...cityCoords[name], 1] : undefined
            })).filter(point => point.value);

            // 2. 分类数据
            const solidLineData = [];
            const dashedLineData = [];
            const allParticlesData = []; 

            lineData.forEach(item => {
                const isSolid = item.isSolid; // 使用预计算好的标志
                const style = getLineStyle(item.weight, isSolid); 

                const lineObject = {
                    name: `${item.origin} → ${item.destination}`,
                    fromName: item.origin,
                    toName: item.destination,
                    weight: item.weight,
                    isSolid: isSolid, 
                    coords: item.coords,
                    lineStyle: {
                        normal: {
                            color: style.color,
                            width: style.lineWidth,
                            shadowBlur: style.shadowBlur,
                            shadowColor: style.color,
                            opacity: isSolid ? 0.9 : 0.4, // 虚线透明度低一点
                            curveness: 0.2,
                            type: isSolid ? 'solid' : 'dashed' // 关键样式
                        }
                    },
                    effect: { color: isSolid ? '#FFFFFF' : style.color } // 实线飞线头用白色，虚线用本色
                };

                if (isSolid) {
                    solidLineData.push(lineObject);
                    // 实线粒子：颜色跟随线条
                    allParticlesData.push({ coords: item.coords, effect: { color: style.color } });
                } else {
                    dashedLineData.push(lineObject);
                    // 虚线粒子：稍微小一点
                    allParticlesData.push({ coords: item.coords, effect: { color: style.color, symbol: 'circle', symbolSize: 3 } });
                }
            });

            // 批量更新
            chart.setOption({
                series: [
                    {}, // 0: map
                    {}, // 1: scatter
                    { data: solidLineData },    // 2: 实线
                    { data: dashedLineData },   // 3: 虚线
                    { data: allParticlesData }, // 4: 粒子
                    { data: activePoints }      // 5: 高亮点
                ]
            });
        }

        // A. 监听数据 (冲突检测逻辑核心)
        function startListening() {
            db.ref("hometownSubmissions").on("value", function(snapshot) {
                lineData = []; 
                
                // 第一步：聚合所有权重，按 "A->B" 为 key 存储
                const rawSubmissions = {}; 
                
                snapshot.forEach(childSnapshot => {
                    const data = childSnapshot.val();
                    const origin = data.origin;
                    const dest = data.destination;
                    const weight = data.weight || 1;

                    if (cityCoords[origin] && cityCoords[dest] && origin !== dest) {
                        const key = `${origin}->${dest}`;
                        if (!rawSubmissions[key]) {
                            rawSubmissions[key] = { origin: origin, destination: dest, weightSum: 0 };
                        }
                        rawSubmissions[key].weightSum += weight;
                    }
                });

                // 第二步：智能判断虚实
                // 遍历所有存在的连接，检查是否存在"反向连接"
                for (const key in rawSubmissions) {
                    const item = rawSubmissions[key];
                    const origin = item.origin;
                    const dest = item.destination;
                    
                    // 构造反向 Key
                    const reverseKey = `${dest}->${origin}`;
                    
                    let isSolid = true; // 默认都是实线

                    // 只有当反向连接 也存在 时，才进行PK
                    if (rawSubmissions[reverseKey]) {
                        // 冲突发生！我们需要一个规则来决定谁是实线，谁是虚线。
                        // 规则：字典序小的起点为实线 (A->B 实, B->A 虚)
                        // 这样能保证每次渲染结果一致，且不会闪烁
                        if (origin.localeCompare(dest, 'zh-CN') > 0) {
                            isSolid = false; // 我是 B->A，所以我变虚线
                        }
                    } 
                    // 如果 rawSubmissions[reverseKey] 不存在，说明是单向连接 (如 C->A)，保持 Solid

                    lineData.push({
                        origin: origin,
                        destination: dest,
                        weight: item.weightSum,
                        coords: [cityCoords[origin], cityCoords[dest]],
                        isSolid: isSolid 
                    });
                }

                updateChart();
            });
        }

        // B. 手动添加
        function manualAddLine() {
            const origin = document.getElementById("pcCitySelect").value;
            const destination = document.getElementById("pcDestinationSelect").value;
            const weight = document.getElementById("pcWeightSelect").value;

            if (!origin || !destination) { alert("请选择起点和终点！"); return; }
            if (origin === destination) { alert("起点和终点不能相同！"); return; }

            db.ref("hometownSubmissions").push({
                origin: origin,
                destination: destination,
                weight: parseInt(weight),
                source: "PC_Manual",
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        // C. 清除
        function clearAllLines() {
            if (!confirm("确定要清除屏幕上所有连线吗？这将同时清空云端历史数据。")) return;
            db.ref("hometownSubmissions").remove().then(() => {
                lineData = [];
                chart.setOption({ series: [{}, {}, { data: [] }, { data: [] }, { data: [] }, { data: [] }] });
            });
        }

        // D. 杂项
        const phonePageUrl = "https://liqing010718-star.github.io/ChuanyuMap/phone.html";
        new QRCode(document.getElementById("qrcode"), {
            text: phonePageUrl, width: 120, height: 120,
            colorDark : "#000000", colorLight : "#ffffff"
        });
        window.addEventListener('resize', () => chart.resize());
    </script>
</body>
</html>

